# CIRRUS self-hosted runner workflow
# Builds and runs all NVHPC configurations (CUDA and NoGPU)
# Useful for comparing GPU vs CPU performance and results
#
name: (CIRRUS) NVHPC GPU vs CPU

on:
  workflow_dispatch:
    branches:
      - master
      - develop

# Image pattern:
#   nogpu: ncarcisl/cisldev-x86_64-almalinux9-nvhpc-{mpi}:devel
#   cuda:  ncarcisl/cisldev-x86_64-almalinux9-nvhpc-{mpi}-cuda:devel

jobs:
  #===========================================================================
  # BUILD: All NVHPC configurations (CUDA and NoGPU)
  #===========================================================================
  build:
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        mpi: [mpich3, openmpi]
        gpu: [nogpu, cuda]
        io: [smiol, pio]

    name: Build (${{ matrix.mpi }}, ${{ matrix.gpu }}, ${{ matrix.io }})
    runs-on:
      group: CIRRUS-4x8-gpu
    container:
      image: ncarcisl/cisldev-x86_64-almalinux9-nvhpc-${{ matrix.mpi }}${{ matrix.gpu == 'cuda' && '-cuda' || '' }}:devel

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Build MPAS-A
        uses: ./.github/actions/build-mpas
        with:
          compiler: nvhpc
          use-pio: ${{ matrix.io == 'pio' }}
          openacc: ${{ matrix.gpu == 'cuda' }}

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: exe-nvhpc-${{ matrix.mpi }}-${{ matrix.gpu }}-${{ matrix.io }}
          path: atmosphere_model
          retention-days: 1

  #===========================================================================
  # RUN: All NVHPC configurations (CUDA and NoGPU)
  #===========================================================================
  run:
    needs: build
    if: ${{ !cancelled() }}
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        mpi: [mpich3, openmpi]
        gpu: [nogpu, cuda]
        io: [smiol, pio]

    name: Run (${{ matrix.mpi }}, ${{ matrix.gpu }}, ${{ matrix.io }})
    runs-on:
      group: CIRRUS-4x8-gpu
    container:
      image: ncarcisl/cisldev-x86_64-almalinux9-nvhpc-${{ matrix.mpi }}${{ matrix.gpu == 'cuda' && '-cuda' || '' }}:devel

    steps:
      - uses: actions/checkout@v4

      - name: Check GPU availability
        if: matrix.gpu == 'cuda'
        run: |
          echo "=== GPU Information ==="
          nvidia-smi || echo "WARNING: nvidia-smi failed"

      - name: Download executable
        id: download
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: exe-nvhpc-${{ matrix.mpi }}-${{ matrix.gpu }}-${{ matrix.io }}

      - name: Run MPAS-A
        if: steps.download.outcome == 'success'
        uses: ./.github/actions/run-mpas
        with:
          executable: ./atmosphere_model
          mpi-impl: ${{ matrix.mpi == 'mpich3' && 'mpich' || 'openmpi' }}
          working-dir: run-${{ matrix.mpi }}-${{ matrix.gpu }}-${{ matrix.io }}

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always() && steps.download.outcome == 'success'
        with:
          name: logs-nvhpc-${{ matrix.mpi }}-${{ matrix.gpu }}-${{ matrix.io }}
          path: run-${{ matrix.mpi }}-${{ matrix.gpu }}-${{ matrix.io }}/log.*
          retention-days: 5

  #===========================================================================
  # VALIDATE: Compare all logs against reference
  #===========================================================================
  validate:
    needs: run
    if: always()
    runs-on: ubuntu-latest
    name: Validate Results

    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download all logs
        id: download-logs
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: logs-*
          path: logs

      - name: Validate logs
        if: steps.download-logs.outcome == 'success'
        uses: ./.github/actions/validate-logs
        with:
          logs-path: logs
          expected-configs: >-
            logs-nvhpc-mpich3-nogpu-smiol,
            logs-nvhpc-mpich3-nogpu-pio,
            logs-nvhpc-openmpi-nogpu-smiol,
            logs-nvhpc-openmpi-nogpu-pio,
            logs-nvhpc-mpich3-cuda-smiol,
            logs-nvhpc-mpich3-cuda-pio,
            logs-nvhpc-openmpi-cuda-smiol,
            logs-nvhpc-openmpi-cuda-pio

      - name: No logs available
        if: steps.download-logs.outcome != 'success'
        run: |
          echo "::warning::No log artifacts available â€” all runs may have been skipped or failed."

  #===========================================================================
  # CLEANUP: Remove executable artifacts
  #===========================================================================
  cleanup:
    needs: [run, validate]
    if: always()
    runs-on: ubuntu-latest
    name: Cleanup

    steps:
      - name: Delete executable artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: exe-*
          failOnError: false
