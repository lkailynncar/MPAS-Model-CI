# GitHub Actions hosted runners workflow
# Builds all compiler/MPI combinations, runs only nogpu configurations
#
name: (GitHub Actions) Build All, Run NoGPU

on:
  workflow_dispatch:
    branches:
      - master
      - develop

jobs:
  #===========================================================================
  # BUILD: All compiler/MPI combinations (nogpu only for GitHub runners)
  #===========================================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC builds
          - compiler: gcc
            mpi: mpich3
            image: ncarcisl/cisldev-x86_64-almalinux9-gcc-mpich3:devel
            build-target: gfortran
          - compiler: gcc
            mpi: openmpi
            image: ncarcisl/cisldev-x86_64-almalinux9-gcc-openmpi:devel
            build-target: gfortran
          
          # NVHPC builds (nogpu)
          - compiler: nvhpc
            mpi: mpich3
            image: ncarcisl/cisldev-x86_64-almalinux9-nvhpc-mpich3:devel
            build-target: nvhpc
          - compiler: nvhpc
            mpi: openmpi
            image: ncarcisl/cisldev-x86_64-almalinux9-nvhpc-openmpi:devel
            build-target: nvhpc
          
          # OneAPI builds
          - compiler: oneapi
            mpi: mpich3
            image: ncarcisl/cisldev-x86_64-almalinux9-oneapi-mpich3:devel
            build-target: intel
          - compiler: oneapi
            mpi: openmpi
            image: ncarcisl/cisldev-x86_64-almalinux9-oneapi-openmpi:devel
            build-target: intel

    name: Build (${{ matrix.compiler }}, ${{ matrix.mpi }})
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Build MPAS-A
        uses: ./.github/actions/build-mpas
        with:
          compiler: ${{ matrix.build-target }}

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: exe-${{ matrix.compiler }}-${{ matrix.mpi }}-nogpu-smiol
          path: atmosphere_model
          retention-days: 1

  #===========================================================================
  # RUN: NoGPU configurations only
  #===========================================================================
  run:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC runs
          - compiler: gcc
            mpi: mpich3
            image: ncarcisl/cisldev-x86_64-almalinux9-gcc-mpich3:devel
            mpi-impl: mpich
          - compiler: gcc
            mpi: openmpi
            image: ncarcisl/cisldev-x86_64-almalinux9-gcc-openmpi:devel
            mpi-impl: openmpi
          
          # NVHPC runs (nogpu)
          - compiler: nvhpc
            mpi: mpich3
            image: ncarcisl/cisldev-x86_64-almalinux9-nvhpc-mpich3:devel
            mpi-impl: mpich
          - compiler: nvhpc
            mpi: openmpi
            image: ncarcisl/cisldev-x86_64-almalinux9-nvhpc-openmpi:devel
            mpi-impl: openmpi
          
          # OneAPI runs
          - compiler: oneapi
            mpi: mpich3
            image: ncarcisl/cisldev-x86_64-almalinux9-oneapi-mpich3:devel
            mpi-impl: mpich
          - compiler: oneapi
            mpi: openmpi
            image: ncarcisl/cisldev-x86_64-almalinux9-oneapi-openmpi:devel
            mpi-impl: openmpi

    name: Run (${{ matrix.compiler }}, ${{ matrix.mpi }})
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Download executable
        uses: actions/download-artifact@v4
        with:
          name: exe-${{ matrix.compiler }}-${{ matrix.mpi }}-nogpu-smiol

      - name: Run MPAS-A
        uses: ./.github/actions/run-mpas
        with:
          executable: ./atmosphere_model
          mpi-impl: ${{ matrix.mpi-impl }}
          working-dir: run-${{ matrix.compiler }}-${{ matrix.mpi }}

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-${{ matrix.compiler }}-${{ matrix.mpi }}-nogpu-smiol
          path: run-${{ matrix.compiler }}-${{ matrix.mpi }}/log.*
          retention-days: 5

  #===========================================================================
  # VALIDATE: Compare all logs against reference
  #===========================================================================
  validate:
    needs: run
    if: always()
    runs-on: ubuntu-latest
    name: Validate Results

    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download all logs
        uses: actions/download-artifact@v4
        with:
          pattern: logs-*
          path: logs

      - name: Validate logs
        uses: ./.github/actions/validate-logs
        with:
          logs-path: logs

  #===========================================================================
  # CLEANUP: Remove executable artifacts
  #===========================================================================
  cleanup:
    needs: [run, validate]
    if: always()
    runs-on: ubuntu-latest
    name: Cleanup

    steps:
      - name: Delete executable artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: exe-*
          failOnError: false
