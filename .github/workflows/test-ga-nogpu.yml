# GitHub Actions hosted runners workflow
# Builds all compiler/MPI combinations, runs only nogpu configurations
#
name: (GitHub Actions) Build All, Run NoGPU

on:
  workflow_dispatch:
    inputs:
      os:
        description: 'Container OS'
        type: choice
        default: 'almalinux9'
        options:
          - almalinux8
          - almalinux9

env:
  REGISTRY: ncarcisl
  IMAGE_PREFIX: cisldev-x86_64

jobs:
  #===========================================================================
  # BUILD: All compiler/MPI combinations (nogpu only for GitHub runners)
  #===========================================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC builds
          - compiler: gcc
            mpi: mpich3
            image-suffix: gcc-mpich3
            build-target: gfortran
          - compiler: gcc
            mpi: openmpi
            image-suffix: gcc-openmpi
            build-target: gfortran
          
          # NVHPC builds (nogpu)
          - compiler: nvhpc
            mpi: mpich3
            image-suffix: nvhpc-mpich3
            build-target: nvhpc
          - compiler: nvhpc
            mpi: openmpi
            image-suffix: nvhpc-openmpi
            build-target: nvhpc
          
          # OneAPI builds
          - compiler: oneapi
            mpi: mpich3
            image-suffix: oneapi-mpich3
            build-target: intel
          - compiler: oneapi
            mpi: openmpi
            image-suffix: oneapi-openmpi
            build-target: intel

    name: Build (${{ matrix.compiler }}, ${{ matrix.mpi }})
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ inputs.os }}-${{ matrix.image-suffix }}:devel

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Build MPAS-A
        uses: ./.github/actions/build-mpas
        with:
          compiler: ${{ matrix.build-target }}

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: exe-${{ matrix.compiler }}-${{ matrix.mpi }}-nogpu-smiol
          path: atmosphere_model
          retention-days: 1

  #===========================================================================
  # RUN: NoGPU configurations only
  #===========================================================================
  run:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC runs
          - compiler: gcc
            mpi: mpich3
            image-suffix: gcc-mpich3
            mpi-impl: mpich
          - compiler: gcc
            mpi: openmpi
            image-suffix: gcc-openmpi
            mpi-impl: openmpi
          
          # NVHPC runs (nogpu)
          - compiler: nvhpc
            mpi: mpich3
            image-suffix: nvhpc-mpich3
            mpi-impl: mpich
          - compiler: nvhpc
            mpi: openmpi
            image-suffix: nvhpc-openmpi
            mpi-impl: openmpi
          
          # OneAPI runs
          - compiler: oneapi
            mpi: mpich3
            image-suffix: oneapi-mpich3
            mpi-impl: mpich
          - compiler: oneapi
            mpi: openmpi
            image-suffix: oneapi-openmpi
            mpi-impl: openmpi

    name: Run (${{ matrix.compiler }}, ${{ matrix.mpi }})
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ inputs.os }}-${{ matrix.image-suffix }}:devel

    steps:
      - uses: actions/checkout@v4

      - name: Download executable
        uses: actions/download-artifact@v4
        with:
          name: exe-${{ matrix.compiler }}-${{ matrix.mpi }}-nogpu-smiol

      - name: Run MPAS-A
        uses: ./.github/actions/run-mpas
        with:
          executable: ./atmosphere_model
          mpi-impl: ${{ matrix.mpi-impl }}
          working-dir: run-${{ matrix.compiler }}-${{ matrix.mpi }}

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-${{ matrix.compiler }}-${{ matrix.mpi }}-nogpu-smiol
          path: run-${{ matrix.compiler }}-${{ matrix.mpi }}/log.*
          retention-days: 5

  #===========================================================================
  # VALIDATE: Compare all logs against reference
  #===========================================================================
  validate:
    needs: run
    if: always()
    runs-on: ubuntu-latest
    name: Validate Results

    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download all logs
        uses: actions/download-artifact@v4
        with:
          pattern: logs-*
          path: logs

      - name: Validate logs
        uses: ./.github/actions/validate-logs
        with:
          logs-path: logs

  #===========================================================================
  # CLEANUP: Remove executable artifacts
  #===========================================================================
  cleanup:
    needs: [run, validate]
    if: always()
    runs-on: ubuntu-latest
    name: Cleanup

    steps:
      - name: Delete executable artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: exe-*
          failOnError: false
